<!DOCTYPE html>
<html>
<head>
  <title>Cricket Bat Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #0f0;
      text-align: center;
      padding: 20px;
    }

    .value {
      font-size: 24px;
      margin: 12px 0;
    }

    button {
      padding: 15px 30px;
      font-size: 18px;
      margin-top: 25px;
    }
  </style>
</head>

<body>

  <h2>ðŸ“± Bat Controller</h2>

  <div class="value">
    Swing Speed: <span id="speed">0</span>
  </div>

  <div class="value">
    Direction: <span id="direction">-</span>
  </div>

  <button onclick="nextBall()">Next Ball</button>

  <script>
    let lastTime = null;
    let lastX = 0, lastY = 0, lastZ = 0;

    let motionEnabled = false;

    // ðŸ”¥ PEAK-AND-HOLD VARIABLES
    let swingPeak = 0;
    let swingActive = false;

    function enableMotion() {
      if (
        typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function"
      ) {
        // iOS
        DeviceMotionEvent.requestPermission()
          .then(response => {
            if (response === "granted") {
              startMotion();
            } else {
              alert("Motion permission denied");
            }
          })
          .catch(console.error);
      } else {
        // Android
        startMotion();
      }
    }

    function startMotion() {
      motionEnabled = true;

      window.addEventListener("devicemotion", (event) => {
        if (!motionEnabled) return;

        const acc = event.accelerationIncludingGravity;
        if (!acc) return;

        const now = Date.now();

        if (lastTime === null) {
          lastTime = now;
          lastX = acc.x || 0;
          lastY = acc.y || 0;
          lastZ = acc.z || 0;
          return;
        }

        const dt = (now - lastTime) / 1000;
        if (dt <= 0) return;

        const dx = acc.x - lastX;
        const dy = acc.y - lastY;
        const dz = acc.z - lastZ;

        const speed = Math.sqrt(dx*dx + dy*dy + dz*dz) / dt;

        // ðŸŽ¯ START SWING
        if (speed > 8) {
          swingActive = true;
          swingPeak = Math.max(swingPeak, speed);
        }

        // ðŸ›‘ END SWING
        if (swingActive && speed < 3) {
          swingActive = false;

          document.getElementById("speed").textContent =
            swingPeak.toFixed(1);

          setTimeout(() => {
            swingPeak = 0;
          }, 1000);
        }

        document.getElementById("direction").textContent =
          dy > 0 ? "Off-side" : "Leg-side";

        lastX = acc.x;
        lastY = acc.y;
        lastZ = acc.z;
        lastTime = now;
      });
    }

    function nextBall() {
      if (!motionEnabled) {
        enableMotion();
      } else {
        alert("Next ball triggered (will connect later)");
      }
    }
  </script>

</body>
